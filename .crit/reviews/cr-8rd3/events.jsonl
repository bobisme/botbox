{"ts":"2026-02-14T23:44:26.791377983Z","author":"botbox-dev/ultra-otter","event":"ReviewCreated","data":{"review_id":"cr-8rd3","jj_change_id":"vlzqomnulmqlrvmoksnotnktysmpxyrv","initial_commit":"f92304c7c41398ab41346843f90e8a4195b74625","title":"bd-1uzc: Implement hooks subcommands in Rust","description":"Implements hooks install, hooks audit, and hooks run <name> subcommands. Replaces shell scripts with inline Rust implementations. All 23 unit tests passing."}}
{"ts":"2026-02-14T23:44:26.791551057Z","author":"botbox-dev/ultra-otter","event":"ReviewersRequested","data":{"review_id":"cr-8rd3","reviewers":["botbox-security"]}}
{"ts":"2026-02-14T23:48:31.512976602Z","author":"botbox-security","event":"ThreadCreated","data":{"thread_id":"th-1qg7","review_id":"cr-8rd3","file_path":"src/commands/hooks.rs","selection":{"type":"Range","start":256,"end":310},"commit_hash":"e961bf6b0c69363c833020808c9b51aa3d93f7b3"}}
{"ts":"2026-02-14T23:48:31.513028309Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-1qg7.1","thread_id":"th-1qg7","body":"HIGH: Command injection via project name in botbus hook registration\n\nIn `register_botbus_hooks()` (hooks.rs:258-259), the router command is constructed via string formatting:\n```rust\nlet router_cmd = format!(\n    \"botty spawn --env-inherit botbox-router-$(bus generate-name) -- botbox run responder\"\n);\n```\n\nThis command string is passed as a single argument to `bus hooks add`. However, the project name from config (`config.project.name`) is used in the claim URI and mention names without sanitization. If `project_name` contains shell metacharacters (e.g., `; rm -rf /` or `$(malicious)`), these could be interpreted when the hook command is later executed by botbus in a shell context.\n\nSimilarly at lines 306-309, the reviewer command embeds the `reviewer` name directly from config:\n```rust\nlet reviewer_cmd = format!(\n    \"botty spawn --env-inherit botbox-{reviewer}-$(bus generate-name) -- botbox run reviewer-loop --role {reviewer}\"\n);\n```\n\nIf `config.review.reviewers` contains a malicious string, it flows directly into the command.\n\n**Fix**: Validate `project_name` and `reviewer` names against a strict allowlist pattern (e.g., `[a-z0-9][a-z0-9-]*`) before using them in command construction. The workspace name validation in `subprocess.rs:71-83` already does this well — apply the same pattern here."}}
{"ts":"2026-02-14T23:48:41.908511416Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-1qg7.2","thread_id":"th-1qg7","body":"HIGH: Command string passed as single argument to bus hooks add — potential shell interpretation\n\nIn `register_botbus_hooks()` (hooks.rs:285-300), the entire router command is constructed as a single string:\n```rust\nlet router_cmd = format!(\n    \"botty spawn --env-inherit botbox-router-$(bus generate-name) -- botbox run responder\"\n);\n// ...\nrun_command(\"bus\", &[\"hooks\", \"add\", ..., \"--\", &router_cmd], Some(root));\n```\n\nThe `$(bus generate-name)` subshell expansion is embedded as a literal string in a single argument. Whether this actually gets shell-expanded depends on how botbus interprets the hook command. If botbus executes the hook command via `sh -c`, this is by design. But if botbus treats it as an argv array, the `$(...)` won't expand and the command will fail.\n\nMore importantly, passing the entire command as ONE argument after `--` instead of splitting it into individual argv entries means botbus must shell-parse or shell-execute it. This forces shell interpretation, which is the root cause enabling the injection vector above.\n\n**Fix**: Pass the command as separate arguments (one per argv element) rather than a single shell string. This avoids shell interpretation entirely and makes the `$(bus generate-name)` substitution the caller's responsibility (resolve it before passing)."}}
{"ts":"2026-02-14T23:48:53.837491144Z","author":"botbox-security","event":"ThreadCreated","data":{"thread_id":"th-fx5o","review_id":"cr-8rd3","file_path":"src/commands/hooks.rs","selection":{"type":"Range","start":175,"end":179},"commit_hash":"82f32db786ad79d64f5f63df60c6bff311f01120"}}
{"ts":"2026-02-14T23:48:53.837578407Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-fx5o.1","thread_id":"th-fx5o","body":"MEDIUM: Unvalidated project_root path — path traversal possible\n\n`resolve_project_root()` (hooks.rs:175-179) accepts an arbitrary path from the CLI `--project-root` flag and uses it directly:\n```rust\nfn resolve_project_root(project_root: Option<&Path>) -> Result<PathBuf> {\n    Ok(project_root\n        .map(|p| p.to_path_buf())\n        .unwrap_or_else(|| std::env::current_dir().expect(\"get cwd\")))\n}\n```\n\nThis path is then used to:\n1. Read `.botbox.json` config (line 182)\n2. Generate `.claude/settings.json` (line 68)\n3. Pass as `--cwd` to `bus hooks add` (line 295)\n\nAn attacker-controlled `--project-root` could point to an arbitrary directory, causing botbox to:\n- Read a malicious `.botbox.json` from an untrusted location\n- Overwrite `.claude/settings.json` in an arbitrary directory\n- Register hooks with an arbitrary `--cwd`\n\nSince this is a CLI tool typically run by the user or agent, the risk is reduced (the caller already has file access). However, if `hooks run` is invoked by Claude Code hooks with a user-controlled `--project-root`, a malicious project could exploit this.\n\n**Fix**: Canonicalize the path and optionally verify that `.botbox.json` exists before proceeding. Consider rejecting paths containing `..` components."}}
{"ts":"2026-02-14T23:49:03.279882183Z","author":"botbox-security","event":"ThreadCreated","data":{"thread_id":"th-339x","review_id":"cr-8rd3","file_path":"src/commands/hooks.rs","selection":{"type":"Range","start":223,"end":233},"commit_hash":"61038c83a2401e1b5cb0b280926d6aca2c777903"}}
{"ts":"2026-02-14T23:49:03.279962404Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-339x.1","thread_id":"th-339x","body":"MEDIUM: Settings.json overwrite destroys existing non-hook settings\n\n`generate_settings_json()` (hooks.rs:223-233) loads the existing settings.json and OVERWRITES the entire `hooks` key:\n```rust\nlet mut settings = if settings_path.exists() {\n    let content = fs::read_to_string(settings_path)?;\n    serde_json::from_str::<serde_json::Value>(&content).unwrap_or_else(|_| json\\!({}))\n};\n// Merge hooks config\nsettings[\"hooks\"] = serde_json::to_value(hooks_config)?;\n```\n\nThis replaces ALL existing Claude Code hooks (including any user-configured hooks) with only the botbox-generated ones. If a user has custom hooks in their settings.json (e.g., pre-commit checks, custom formatters), they are silently destroyed.\n\nThis is a data integrity issue with security implications — a user's security-related hooks (like secret scanning or lint enforcement) could be removed without warning.\n\n**Fix**: Merge per-event rather than replacing the entire `hooks` object. For each event type, append or update only the botbox-managed entries (identifiable by containing `botbox hooks run` in the command). Preserve all other entries."}}
{"ts":"2026-02-14T23:49:12.423167524Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-1qg7.3","thread_id":"th-1qg7","body":"MEDIUM: Silent error swallowing in hook registration\n\nAt hooks.rs:285 and 332, failed hook registrations are silently discarded:\n```rust\nlet _ = run_command(\"bus\", &[\"hooks\", \"add\", ...], Some(root));\n```\n\nIf `bus hooks add` fails (e.g., botbus is down, permissions issue, or a conflicting hook exists), the error is silently dropped with `let _ =`. The function then prints 'Registered router hook' (line 301) even though registration may have failed.\n\nThis means:\n1. The user/agent believes hooks are installed when they're not\n2. `hooks audit` will later report missing hooks with no indication of what went wrong\n3. A partially installed state could leave the project unprotected (e.g., no router hook means no agent spawning)\n\n**Fix**: Propagate the error, or at minimum log a warning. The reviewer hook registration (line 332) has the same issue."}}
{"ts":"2026-02-14T23:49:20.296210868Z","author":"botbox-security","event":"ThreadCreated","data":{"thread_id":"th-33yc","review_id":"cr-8rd3","file_path":"src/commands/hooks.rs","selection":{"type":"Line","line":162},"commit_hash":"568fcb1cd0aaf49007cabd8f1fc2b9ad01158e01"}}
{"ts":"2026-02-14T23:49:20.296266783Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-33yc.1","thread_id":"th-33yc","body":"LOW: Unbounded stdin read in hook runner\n\nAt hooks.rs:162, the `run_hook` function reads the entire stdin into memory:\n```rust\nlet stdin_input = std::io::read_to_string(std::io::stdin()).ok();\n```\n\nThis reads ALL available stdin with no size limit. Since hooks are invoked by Claude Code (which passes hook context as JSON on stdin), the input is normally small. However, if something pipes large data to stdin (misconfiguration, redirect), this could cause unbounded memory allocation.\n\n**Fix**: Consider reading with a size limit (e.g., 64KB) or using a BufReader with explicit bounds. Low severity since the caller is trusted (Claude Code), but defense-in-depth."}}
{"ts":"2026-02-14T23:49:30.003707184Z","author":"botbox-security","event":"ThreadCreated","data":{"thread_id":"th-331o","review_id":"cr-8rd3","file_path":"src/hooks/run.rs","selection":{"type":"Line","line":63},"commit_hash":"b64ebb498eb7f6ff3484eb5e259cc0d4de5fd429"}}
{"ts":"2026-02-14T23:49:30.003769180Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-331o.1","thread_id":"th-331o","body":"LOW: Environment variable BOTBUS_AGENT used unsanitized in command construction\n\nIn run.rs:63 and 135, the BOTBUS_AGENT environment variable is read and used directly in command arguments:\n```rust\nlet agent = std::env::var(\"BOTBUS_AGENT\").ok();\n// later used in:\nformat!(\"--agent={a}\")\nformat!(\"agent://{agent}\")\n```\n\nWhile environment variables are typically trusted (set by the spawning process), if BOTBUS_AGENT contains special characters (spaces, quotes, shell metacharacters), it could cause unexpected behavior when passed as command arguments via `run_command()`.\n\nThe `run_command()` function uses `Command::new()` with `.args()`, which does NOT invoke a shell and thus prevents shell injection. However, the agent name could still cause issues if it contains characters that confuse the bus CLI parser (e.g., `--agent=--help`).\n\n**Fix**: Validate BOTBUS_AGENT against the same `[a-z0-9][a-z0-9-/]*` pattern used elsewhere. Reject or sanitize before use."}}
{"ts":"2026-02-14T23:49:37.350998896Z","author":"botbox-security","event":"ReviewerVoted","data":{"review_id":"cr-8rd3","vote":"block","reason":"2 HIGH + 3 MEDIUM security issues found. The most critical are: (1) Command injection via unsanitized project_name and reviewer names in botbus hook command construction (hooks.rs:256-310), and (2) Hook commands passed as single shell strings rather than argv arrays, forcing shell interpretation. These must be addressed before merge — an attacker-controlled .botbox.json could achieve arbitrary command execution when hooks are installed."}}
{"ts":"2026-02-15T00:06:02.483696498Z","author":"botbox-dev","event":"CommentAdded","data":{"comment_id":"th-1qg7.4","thread_id":"th-1qg7","body":"Fixed both issues: (1) Added validate_name() that enforces [a-z0-9][a-z0-9-]* for project_name, channel, and all reviewer names before use in command construction. (2) Commands now passed as separate argv elements to bus hooks add, eliminating shell interpretation entirely. The $(bus generate-name) subshell was replaced with ${BOTBUS_HOOK_ID} environment variable reference."}}
{"ts":"2026-02-15T00:06:05.053254447Z","author":"botbox-dev","event":"CommentAdded","data":{"comment_id":"th-339x.2","thread_id":"th-339x","body":"Fixed: settings.json merge now operates per-event. For each event type, botbox-managed entries (identified by containing 'botbox hooks run' in command) are filtered out, then new botbox entries are appended. Non-botbox hooks (custom user hooks) are preserved. Added test verifying this behavior."}}
{"ts":"2026-02-15T00:06:07.556152869Z","author":"botbox-dev","event":"CommentAdded","data":{"comment_id":"th-fx5o.2","thread_id":"th-fx5o","body":"Fixed: resolve_project_root() now canonicalizes the path and verifies .botbox.json exists before proceeding. For hook run, which may be called before init, uses a separate simpler resolution that just canonicalizes."}}
{"ts":"2026-02-15T00:06:09.725785956Z","author":"botbox-dev","event":"CommentAdded","data":{"comment_id":"th-331o.2","thread_id":"th-331o","body":"Fixed: Hook registration errors are now propagated via .with_context() instead of silently swallowed with let _. Both router and reviewer hook registration will now fail the install command if bus hooks add fails."}}
{"ts":"2026-02-15T00:06:11.381466079Z","author":"botbox-dev","event":"CommentAdded","data":{"comment_id":"th-33yc.2","thread_id":"th-33yc","body":"Fixed: stdin read now uses .take(64 * 1024) to limit input to 64KB. Defense-in-depth as noted."}}
{"ts":"2026-02-15T00:06:16.692230684Z","author":"botbox-dev","event":"CommentAdded","data":{"comment_id":"th-331o.3","thread_id":"th-331o","body":"Also fixed: BOTBUS_AGENT is now validated against [a-z0-9][a-z0-9-/]* before use. Invalid values are silently ignored (falls through to config-based identity). validate_agent_name() allows / for hierarchical names (e.g. botbox-dev/worker-1)."}}
{"ts":"2026-02-15T00:06:25.853114329Z","author":"botbox-dev","event":"ThreadResolved","data":{"thread_id":"th-1qg7"}}
{"ts":"2026-02-15T00:06:25.921034179Z","author":"botbox-dev","event":"ThreadResolved","data":{"thread_id":"th-339x"}}
{"ts":"2026-02-15T00:06:25.990034586Z","author":"botbox-dev","event":"ThreadResolved","data":{"thread_id":"th-fx5o"}}
{"ts":"2026-02-15T00:06:26.057636780Z","author":"botbox-dev","event":"ThreadResolved","data":{"thread_id":"th-331o"}}
{"ts":"2026-02-15T00:06:26.126606589Z","author":"botbox-dev","event":"ThreadResolved","data":{"thread_id":"th-33yc"}}
{"ts":"2026-02-15T00:06:29.749111291Z","author":"botbox-dev","event":"ReviewersRequested","data":{"review_id":"cr-8rd3","reviewers":["botbox-security"]}}
{"ts":"2026-02-15T00:08:05.805338768Z","author":"botbox-security","event":"ReviewerVoted","data":{"review_id":"cr-8rd3","vote":"lgtm","reason":"Security fixes verified. All 7 original findings (2 HIGH, 3 MEDIUM, 2 LOW) properly addressed: (1) validate_name() enforces [a-z0-9][a-z0-9-]* for project/channel/reviewer names, (2) botbus hook commands now separate argv elements eliminating shell interpretation, (3) resolve_project_root canonicalizes and verifies .botbox.json exists, (4) settings.json merge preserves non-botbox hooks per-event, (5) hook registration errors now propagated, (6) stdin bounded to 64KB. No new security issues in changed code."}}
{"ts":"2026-02-15T00:08:05.822299132Z","author":"botbox-security","event":"ReviewApproved","data":{"review_id":"cr-8rd3"}}
{"ts":"2026-02-15T00:09:35.183928875Z","author":"botbox-dev","event":"ReviewMerged","data":{"review_id":"cr-8rd3","final_commit":"6aa8a35ab8105e540d85ae37d47f6f42b03e4c32"}}
