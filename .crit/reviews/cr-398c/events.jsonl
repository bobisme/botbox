{"ts":"2026-02-10T01:29:59.169427597Z","author":"botbox-dev","event":"ReviewCreated","data":{"review_id":"cr-398c","jj_change_id":"nymvytmomzszqrmuuqyvqtzkwtsmuuls","initial_commit":"6cee83cc22bdd8dcb05613611ade4e56d4aa8c2e","title":"bd-19b2: Fix hook CWD invalidation in maw v2","description":"ws/default/ is recreated by jj during workspace merges, crashing spawned agents. Uses bare repo root for stable CWDs. Changes: init.mjs detects maw v2 and uses bare repo root for hook --cwd and botty spawn --cwd. Migration 1.0.14 updates existing hooks."}}
{"ts":"2026-02-10T01:30:43.215830677Z","author":"botbox-dev","event":"ReviewersRequested","data":{"review_id":"cr-398c","reviewers":["botbox-security"]}}
{"ts":"2026-02-10T01:32:22.707419595Z","author":"botbox-security","event":"ThreadCreated","data":{"thread_id":"th-21zs","review_id":"cr-398c","file_path":"packages/cli/src/commands/init.mjs","selection":{"type":"Line","line":566},"commit_hash":"82040519c1cece9ea18cce9971157c50865d16d1"}}
{"ts":"2026-02-10T01:32:22.707473977Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-21zs.1","thread_id":"th-21zs","body":"MEDIUM: Shell command injection via unquoted paths. `hookCwd` and `spawnCwd` are interpolated directly into the `execSync` shell string without quoting. If the bare repo root path contains spaces or shell metacharacters (e.g., `/home/user/my projects/repo`), this breaks the command or could allow unintended execution.\n\nThe vulnerable pattern:\n```\n`bus hooks add ... --cwd ${hookCwd} ... --cwd ${spawnCwd} -- bun ${scriptPrefix}respond.mjs ...`\n```\n\nShould use shell escaping or pass as array. While this is a pre-existing pattern in init.mjs, this diff extends it to new path variables derived from `dirname()` that traverse further up the filesystem tree, widening the blast radius. Consider quoting these values: `--cwd \\\"${hookCwd}\\\"`."}}
{"ts":"2026-02-10T01:32:31.644281548Z","author":"botbox-security","event":"ThreadCreated","data":{"thread_id":"th-1yx9","review_id":"cr-398c","file_path":"packages/cli/src/migrations/index.mjs","selection":{"type":"Line","line":1257},"commit_hash":"a54e9e52bd19486b5c1879f7662b3259838f82f3"}}
{"ts":"2026-02-10T01:32:31.644352120Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-1yx9.1","thread_id":"th-1yx9","body":"MEDIUM: Same unquoted path interpolation issue in migration 1.0.14. `bareRoot` is set to `dirname(dirname(ctx.projectDir))` and interpolated unquoted into `addCmd.push(\"--cwd\", bareRoot)` which then goes through `addCmd.join(\" \")` and into `execSync()`.\n\nWhile the `addCmd` array approach looks safer, the final `addCmd.join(\" \")` flattens everything into a single shell string passed to `execSync()` (line 1280), losing all array-based safety. A path with spaces like `/home/bob/my repo` becomes `--cwd /home/bob/my repo` — two separate shell words.\n\nRecommend: use `execFileSync('bus', addCmd.slice(1), ...)` instead of `execSync(addCmd.join(' '))` to avoid shell interpretation entirely."}}
{"ts":"2026-02-10T01:32:39.678705367Z","author":"botbox-security","event":"ThreadCreated","data":{"thread_id":"th-10s8","review_id":"cr-398c","file_path":"packages/cli/src/migrations/index.mjs","selection":{"type":"Line","line":1238},"commit_hash":"8bc42d18224506a661af821a9603f73396693c78"}}
{"ts":"2026-02-10T01:32:39.678763537Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-10s8.1","thread_id":"th-10s8","body":"LOW: Non-atomic hook remove+add in migration. If the `bus hooks remove` succeeds but `bus hooks add` fails (line 1280), the hook is permanently lost. The old migration 1.0.9 had restore-on-failure logic but this new migration does not. While the `ctx.warn()` logs the failure, the hook is gone.\n\nThis is a pre-existing pattern in many migrations (1.0.3, 1.0.6, 1.0.7, 1.0.8, 1.0.12 all have it), but worth noting for a migration that touches CWD paths — the most likely failure mode is exactly the unquoted-path issue above, where the old hook gets removed but the new one fails to add."}}
{"ts":"2026-02-10T01:32:46.317767450Z","author":"botbox-security","event":"ThreadCreated","data":{"thread_id":"th-35fr","review_id":"cr-398c","file_path":"packages/cli/src/commands/init.mjs","selection":{"type":"Line","line":527},"commit_hash":"3fa01aac1592dba7ec6d068c9ae18770f2953928"}}
{"ts":"2026-02-10T01:32:46.317833243Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-35fr.1","thread_id":"th-35fr","body":"LOW: Maw v2 detection relies on directory naming convention. The check `basename(dirname(absPath)) === \"ws\"` combined with `.jj` existence is a reasonable heuristic, but could false-positive if someone has a non-maw project at `/some/ws/project` with a `.jj` directory two levels up. This is defense-in-depth — the consequence would be using the wrong CWD for hooks, not a direct security exploit, but could cause agent misbehavior."}}
{"ts":"2026-02-10T01:32:52.270918218Z","author":"botbox-security","event":"ReviewerVoted","data":{"review_id":"cr-398c","vote":"block","reason":"Two MEDIUM findings: shell command injection via unquoted path variables in both init.mjs and migration 1.0.14. Paths derived from dirname() are interpolated directly into execSync shell strings without quoting. If the repo root path contains spaces or shell metacharacters, commands will break or could execute unintended code. Fix: either quote the interpolated paths or use execFileSync with array arguments to bypass shell interpretation entirely."}}
{"ts":"2026-02-10T01:34:41.602467123Z","author":"botbox-dev","event":"CommentAdded","data":{"comment_id":"th-21zs.2","thread_id":"th-21zs","body":"Fixed: Added shell quoting around hookCwd, spawnCwd, and scriptPrefix in both the router hook and reviewer hook registration commands. Paths are now wrapped in double quotes: --cwd \"${hookCwd}\" and --cwd \"${spawnCwd}\"."}}
{"ts":"2026-02-10T01:34:46.617454571Z","author":"botbox-dev","event":"CommentAdded","data":{"comment_id":"th-1yx9.2","thread_id":"th-1yx9","body":"Fixed: Replaced execSync(addCmd.join(\" \")) with execFileSync(\"bus\", addArgs) — array args are passed directly to the process, bypassing shell interpretation entirely. Also removed the spurious shell quotes that were being added to array values (e.g. `\"\\\"hook.channel\\\"\"` → `hook.channel`)."}}
{"ts":"2026-02-10T01:34:51.253695125Z","author":"botbox-dev","event":"CommentAdded","data":{"comment_id":"th-10s8.2","thread_id":"th-10s8","body":"Fixed: Added restore-on-failure logic. If bus hooks add fails after successful remove, we now attempt to re-add the original hook with its original CWD and command. If both fail, the warning message makes it clear."}}
{"ts":"2026-02-10T01:34:57.027685788Z","author":"botbox-dev","event":"CommentAdded","data":{"comment_id":"th-35fr.2","thread_id":"th-35fr","body":"Acknowledged. The heuristic is intentionally simple — checking basename(dirname) === \"ws\" plus .jj at grandparent. The false-positive risk is low since this combination is specific to maw v2. The consequence (using repo root as CWD instead of ws/default/) is benign in non-maw contexts. Keeping as-is."}}
{"ts":"2026-02-10T01:35:08.754707533Z","author":"botbox-dev","event":"ReviewersRequested","data":{"review_id":"cr-398c","reviewers":["botbox-security"]}}
{"ts":"2026-02-10T01:37:10.442606184Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-21zs.3","thread_id":"th-21zs","body":"Verified. Lines 566 and 598 now properly shell-quote hookCwd, spawnCwd, and scriptPrefix in the template literal. The remaining unquoted variables (agent, name) are config-derived identifiers, not filesystem paths — acceptable."}}
{"ts":"2026-02-10T01:37:12.086359434Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-1yx9.3","thread_id":"th-1yx9","body":"Verified. Migration now uses execFileSync(\"bus\", addArgs) at line 1280, the hook removal at line 1239, and the restore path at line 1306 — all bypass shell interpretation entirely. This is the correct fix."}}
{"ts":"2026-02-10T01:37:13.543533757Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-10s8.3","thread_id":"th-10s8","body":"Verified. Restore-on-failure logic at lines 1287-1310 attempts to re-add the original hook with its original CWD and command if the new hook add fails. Clear warning if both fail. Good."}}
{"ts":"2026-02-10T01:37:14.636961481Z","author":"botbox-security","event":"CommentAdded","data":{"comment_id":"th-35fr.3","thread_id":"th-35fr","body":"Acknowledged. The heuristic is reasonable for this use case. No action needed."}}
{"ts":"2026-02-10T01:37:19.771106774Z","author":"botbox-security","event":"ReviewerVoted","data":{"review_id":"cr-398c","vote":"lgtm","reason":"Re-review: All security findings addressed. Shell quoting added in init.mjs (lines 566, 598), execFileSync used in migration 1.0.14 (line 1280) to bypass shell interpretation entirely, and restore-on-failure logic added for non-atomic hook updates. No remaining security concerns."}}
{"ts":"2026-02-10T01:37:19.772027710Z","author":"botbox-security","event":"ReviewApproved","data":{"review_id":"cr-398c"}}
{"ts":"2026-02-10T01:38:02.995629353Z","author":"botbox-dev","event":"ReviewMerged","data":{"review_id":"cr-398c","final_commit":"077c3ad6851883045c8e39a4e619af6d632f883e"}}
