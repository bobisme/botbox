# Agent Loop Eval - Run 2 (Sonnet, Happy Path)
**Date**: 2026-01-30
**Agent**: storm-raven (generated by botbus)
**Model**: Sonnet (claude -p --model sonnet --dangerously-skip-permissions)
**Task**: 2 beads of varying quality
**Environment**: /tmp/tmp.NmMtwXyuso
**Script**: scripts/agent-loop.sh (MAX_LOOPS=5, LOOP_PAUSE=2)

---

## Summary

First successful happy-path agent-loop eval. Both beads completed across 2 iterations, with proper loop termination on iteration 4 (iteration 3 was a wasted claude session due to unread self-messages).

**Timeline:**
```
Loop 1: has_work()=true → claude -p → bd-1hr completed (status endpoint)
Loop 2: has_work()=true → claude -p → bd-38x completed (rate limiting)
Loop 3: has_work()=true → claude -p → NO_WORK_AVAILABLE (reads own messages)
Loop 4: has_work()=false → "No work available. Exiting cleanly." → agent-idle
Final: br sync, agent-shutdown announcement, cleanup
```

---

## Shell Script Mechanics (30 points)

| Criterion | Points | Evidence |
|-----------|--------|----------|
| **Agent lease claimed** | 5/5 | `agent://storm-raven` claimed at start |
| **Spawn announcement** | 5/5 | "Agent storm-raven online, starting worker loop" with `-L mesh -L spawn-ack` |
| **`has_work()` gates iteration** | 4/5 | Correctly returned false on Loop 4. But Loop 3 was a false positive — unread self-messages (own "Completed" announcements) made inbox_count > 0. Agent handled it gracefully. |
| **One bead per iteration** | 5/5 | Loop 1: exactly bd-1hr. Loop 2: exactly bd-38x. |
| **Cleanup on exit** | 5/5 | "Cleanup complete for storm-raven", no remaining claims |
| **Shutdown announcement** | 5/5 | "Agent storm-raven shutting down after 3 loops." + "No work remaining. Agent storm-raven signing off." (agent-idle) |

**Shell Mechanics Subtotal**: 29/30

### Remaining has_work() Issue

Loop 3 spawned an unnecessary Claude session because the agent's own botbus messages ("Completed bd-38x") created unread messages in the project channel. The spawned agent correctly determined NO_WORK_AVAILABLE and exited, but this is wasted cost. Possible fixes:
- has_work() checks only `br ready` count, not inbox
- Self-messages excluded from inbox count
- Agent marks read via `--mark-read` in triage, preventing repeat

---

## Per-Iteration Protocol

### Iteration 1: bd-1hr (Add status endpoint) — well-specified

#### Critical Steps (10 points each)

| Step | Evidence | Score |
|------|----------|-------|
| **Claim on botbus** | ✅ `bead://eval-loop-2/bd-1hr` + `workspace://eval-loop-2/cosmic-owl` | 10/10 |
| **Start bead (in_progress)** | ✅ bd-1hr → in_progress | 10/10 |
| **Finish bead (closed)** | ✅ bd-1hr closed at 02:33:11 | 10/10 |
| **Release claims** | ✅ No claims after loop 1 | 10/10 |
| **Sync beads** | ✅ issues.jsonl updated | 10/10 |

#### Optional Steps (2 points each)

| Step | Evidence | Score |
|------|----------|-------|
| **Generate identity** | N/A (provided by script) | — |
| **Run triage** | ✅ Used `bv --robot-next`, selected bd-1hr | 2/2 |
| **Groom beads** | ✅ Grooming comment on bd-38x during triage ("needs more detail") | 2/2 |
| **Create workspace** | ✅ `maw ws create --random` → cosmic-owl | 2/2 |
| **Work from workspace path** | ✅ Files in `.workspaces/cosmic-owl/` | 2/2 |
| **Post progress updates** | ✅ "Progress: Creating Flask API structure with /status endpoint" | 2/2 |
| **Announce on botbus** | ✅ "Working on bd-1hr" + "Completed bd-1hr" | 2/2 |
| **Destroy workspace** | ✅ cosmic-owl gone, commits on default | 2/2 |

#### Work Quality (20 points)

| Criterion | Assessment | Score |
|-----------|------------|-------|
| **Task completed** | ✅ GET /status returns {"status":"ok","version":"1.0.0"} | 7/7 |
| **Tests pass** | ✅ 4/4 tests passing (200 status, valid JSON, status field, version field) | 7/7 |
| **Code quality** | ✅ Clean Flask app, no unnecessary dependencies | 6/6 |

#### Error Handling (10 points)

| Criterion | Assessment | Score |
|-----------|------------|-------|
| **Progress updates** | ✅ Progress comment during work | 5/5 |
| **Bug reporting** | N/A | 5/5 |

**Iteration 1 Subtotal**: 94/94 (identity N/A)

---

### Iteration 2: bd-38x (rate limiting) — poorly specified

#### Critical Steps (10 points each)

| Step | Evidence | Score |
|------|----------|-------|
| **Claim on botbus** | ✅ `bead://eval-loop-2/bd-38x` + `workspace://eval-loop-2/swift-phoenix` | 10/10 |
| **Start bead (in_progress)** | ✅ bd-38x → in_progress | 10/10 |
| **Finish bead (closed)** | ✅ bd-38x closed at 02:36:44 | 10/10 |
| **Release claims** | ✅ No claims after loop 2 | 10/10 |
| **Sync beads** | ✅ issues.jsonl updated | 10/10 |

#### Optional Steps (2 points each)

| Step | Evidence | Score |
|------|----------|-------|
| **Generate identity** | N/A (provided by script) | — |
| **Run triage** | ✅ Found bd-38x as only remaining work | 2/2 |
| **Groom beads** | ✅ Groomed bd-38x: added acceptance criteria (100 req/min/IP, 429 status, Retry-After header) and testing strategy. Updated bead description. | 2/2 |
| **Create workspace** | ✅ `maw ws create --random` → swift-phoenix | 2/2 |
| **Work from workspace path** | ✅ Agent reported working in workspace | 2/2 |
| **Post progress updates** | ⚠️ No explicit "Progress:" comment during work (only grooming and completion comments) | 0/2 |
| **Announce on botbus** | ✅ "Working on bd-38x" + "Completed bd-38x" | 2/2 |
| **Destroy workspace** | ⚠️ swift-phoenix still exists (same commit as default, not destroyed) | 0/2 |

#### Work Quality (20 points)

| Criterion | Assessment | Score |
|-----------|------------|-------|
| **Task completed** | ✅ Flask-Limiter with 100 req/min per IP, 429 responses, Retry-After headers | 7/7 |
| **Tests pass** | ✅ 7/7 tests passing (4 status + 3 rate limit) | 7/7 |
| **Code quality** | ✅ Clean implementation, proper library usage | 6/6 |

#### Error Handling (10 points)

| Criterion | Assessment | Score |
|-----------|------------|-------|
| **Progress updates** | ⚠️ Grooming comment exists but no progress update during implementation | 3/5 |
| **Bug reporting** | N/A | 5/5 |

**Iteration 2 Subtotal**: 88/94 (identity N/A)

---

## Total Score

| Category | Score |
|----------|-------|
| Shell Script Mechanics | 29/30 |
| Iteration 1 Protocol | 94/94 |
| Iteration 2 Protocol | 88/94 |
| **TOTAL** | **211/218** |

**Result**: **EXCELLENT (97%)**

---

## Grooming Quality

The agent's grooming of bd-38x was exemplary:

**Before** (seeded):
- Title: "add rate limiting or something"
- Description: "api gets too many requests sometimes"

**After** (groomed):
- Title: preserved (could have been improved)
- Description: "Implement rate limiting for the Flask API..."
- Added acceptance criteria: 100 req/min/IP, HTTP 429, Retry-After header
- Added testing strategy: enforcement test, header verification, normal operation test

The agent turned a 7-word vague description into a fully-specified bead with clear acceptance criteria and testing strategy.

---

## Issues Found

### 1. Workspace swift-phoenix not destroyed
Loop 2's workspace wasn't cleaned up. `maw ws list` shows swift-phoenix still exists at the same commit as default. The `maw ws merge --destroy` command may have partially failed (merge worked, destroy didn't) or there was a conflict during merge.

### 2. Beads merge conflict (transient)
During Loop 2, `.beads/issues.jsonl` had merge conflict markers. This resolved by the end of the run but indicates a jj merge issue with the beads database file when workspaces are merged.

### 3. Wasted Loop 3
Agent's own botbus messages create unread counts that trigger has_work(). Cost: one unnecessary Claude session.

### 4. No progress comment on iteration 2
Agent posted grooming and completion comments but no explicit "Progress: ..." update during implementation work.

---

## Comparison Across All Evals

| Eval | Model | Type | Beads | Score | Key Finding |
|------|-------|------|-------|-------|-------------|
| L2 Run 1 | Opus | Single session | 1 | 92/92 (100%) | Baseline: perfect |
| L2 Run 2 | Sonnet | Single session | 1 | 81/92 (88%) | Missing optional steps |
| L2 Run 3 | Sonnet | Single session | 1 | 88/92 (96%) | Progress docs helped |
| L2 Run 4 | Sonnet | Single session | 1 | 83/92 (90%) | Workspace destroy helped |
| L2 Run 5 | Sonnet | Single session | 3 | 89/96 (93%) | Multi-bead unlocked triage |
| L2 Run 6 | Sonnet | Single session | 2 | 92/96 (96%) | Workspace path confirmed |
| **Loop Run 1** | **Sonnet** | **agent-loop.sh** | **2** | **28/30 shell** | **Sandbox blocked all work** |
| **Loop Run 2** | **Sonnet** | **agent-loop.sh** | **2** | **211/218 (97%)** | **Happy path works!** |

---

## Raw Data

### Bead Close Timestamps
```
bd-1hr|closed|2026-01-30T02:33:11.583436888+00:00
bd-38x|closed|2026-01-30T02:36:44.183201548+00:00
```

### Botbus Messages
```
02:30:41 Agent storm-raven online, starting worker loop
02:31:43 Working on bd-1hr
02:34:14 Completed bd-1hr
02:35:12 Working on bd-38x
02:37:34 Completed bd-38x
02:38:24 No work remaining. Agent storm-raven signing off.
02:38:24 Agent storm-raven shutting down after 3 loops.
```

### jj History
```
@ polyvlqm feat: Add rate limiting (100 req/min per IP) with Flask-Limiter
○ xnymqprr (empty)
○ pomwlzmv feat: Add GET /status endpoint
○ stqzzqsp Initial botbox setup for agent-loop eval run 2
◆ zzzzzzzz root()
```

### Test Results
```
7 passed in 0.15s
- test_status_returns_200
- test_status_returns_valid_json
- test_status_has_status_field
- test_status_has_version_field
- test_rate_limiting_enforced
- test_rate_limit_headers
- test_normal_requests_under_limit
```
