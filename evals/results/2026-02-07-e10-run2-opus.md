# E10 Run 2: Full Lifecycle

**Date:** 2026-02-07
**Alpha-dev model:** Opus (claude-opus-4-6 via `botbox run-agent`)
**Alpha-security model:** Opus (claude-opus-4-6 via `botbox run-agent`)
**Beta-dev model:** Sonnet (claude-sonnet-4-5-20250929 via `botbox run-agent`)
**Score:** 159/160 (99%) — EXCELLENT

## Tool Versions

From `$EVAL_DIR/artifacts/tool-versions.env`:

| Tool | Version |
|------|---------|
| botbox | 0.2.0 |
| bus | 0.25.0 |
| br | 0.1.13 |
| maw | 0.25.0 |
| crit | 0.14.0 |
| botty | 0.9.0 |
| jj | 0.37.0 |
| cargo | 1.93.0 |
| claude | 2.1.34 |

## Phase Scores

| Phase | Max | Score | Notes |
|-------|-----|-------|-------|
| 1: Triage + Implement + Discovery | 30 | 30 | Perfect. Inbox, claims, workspace, implementation, 4 tests, bug discovery via test failure, cross-project message to beta. |
| 2: Beta Investigates | 15 | 15 | Reads inbox mentions, investigates code, cites RFC 5321, creates bd-1xk bug bead, responds on alpha channel. |
| 3: Beta Fix + Release | 15 | 15 | Used `maw ws merge --destroy` correctly (improvement over E10-1). All 7 tests pass. |
| 4: Alpha Resume + Review | 20 | 20 | Reads fix announcement, verifies all 4 tests pass, creates crit review with --path, requests reviewer, announces with @mention. |
| 4.5: Hook Verification | 5 | 5 | 3/3 automated checks pass. |
| 5: Security Review | 20 | 20 | Found /debug + api_secret (CRITICAL), plus 6 more issues (2 CRITICAL, 1 HIGH, 3 MEDIUM, 1 LOW). Read from workspace path. Compared with main branch code. Blocked review. |
| 6: Fix Feedback | 15 | 15 | Removed /debug endpoint entirely, loaded secret from env var, replied on 3 threads (th-25tx, th-vhhk, th-3u65), re-requested review with @mention. |
| 7: Re-review | 10 | 10 | Read from workspace, verified /debug removed line by line, confirmed env var loading, LGTM'd. |
| 8: Merge + Finish | 15 | 15 | Full finish protocol: mark-merged, ws merge --destroy, close bead, release 3 claims, sync, bump to 0.2.0, tag v0.2.0, announce. |
| Communication | 15 | 14 | 2 progress comments on bead (blocked on beta, requesting review). Labels correct throughout. Identity flags consistent. -1 for no comment during Phase 6 fix cycle. |
| **Total** | **160** | **159** | |

## Critical Fail Conditions

- [x] Alpha merges while review BLOCKED — No. Phase 8 verifies LGTM before proceeding.
- [x] No cross-project message to beta channel — alpha-dev sent `bus send beta "Hey @beta-dev..." -L feedback` in Phase 1.
- [x] /debug still exposes api_secret after Phase 6 — /debug route and handler removed entirely. api_secret loaded from env var, not exposed via any endpoint.
- [x] Missing --agent/--actor on mutating commands — Consistent `--agent`/`--actor` throughout all 8 phases.
- [x] Claims unreleased after Phase 8 — 3 work claims released. Only `agent://alpha-dev` remains (re-staked by hooks — expected behavior).

No critical fails.

## Key Findings

- **159/160 with identical tool versions as E10-1**: Confirms reproducibility — agents consistently follow the full protocol across runs. The 1-point improvement over E10-1 comes from Phase 3 (beta-dev used `maw ws merge --destroy` correctly this time, not the `jj squash` workaround).
- **Phase 5 reviewer found 7 issues**: 2 CRITICAL (secret leak via /debug, hardcoded api_secret), 1 HIGH (unauthenticated debug endpoint), 3 MEDIUM (no input limits, mutex panic risk, no email uniqueness), 1 LOW (bind address). Consistent depth with E10-1.
- **Phase 6 replied to 3 critical/high threads**: Focused on the blocking issues (CRITICAL and HIGH) rather than addressing all 7 threads. Pragmatic — the MEDIUM/LOW issues weren't blocking.
- **No setup workarounds needed**: Unlike E10-1 which required creative workarounds for missing `main` bookmark and broken Cargo.toml paths, E10-2 agents ran clean without encountering setup issues. The E10-1 fixes to the setup script worked.
- **FALLBACK for REVIEW_ID**: The orchestrator used the stdout grep fallback to recover `cr-2dk6` because `crit reviews list --all-workspaces` still fails with FK constraint error. Thread ID (`th-2kw1`) was discovered correctly.
- **Run time ~10 minutes**: Significantly faster than E10-1 (which had multiple trial runs). Clean run from setup to completion.
- **crit mark-merged event lost on workspace destroy**: `crit reviews mark-merged` was run with `--path` pointing to workspace, then `maw ws merge --destroy` deleted the workspace including its .crit directory. The merged event was lost. Verify script correctly flags this as FAIL but it's a tool lifecycle issue, not an agent failure.
- **Significant tool friction despite high score**: 159/160 workflow compliance masks ~34 wasted tool calls from crit `--path` requirement and a stale workspace cascade. See Tool Friction Analysis below.

## Tool Friction Analysis

Despite a near-perfect workflow compliance score, agents experienced substantial friction with crit and jj. The high score reflects that agents always recovered — but recovery cost significant tool calls, context, and time.

### Summary

| Category | Occurrences | Wasted Tool Calls | Phases Affected |
|----------|------------|-------------------|-----------------|
| crit `--path` missing | 5 | ~34 (failures + sibling cancellations) | 4, 5, 6, 7, 8 |
| crit stale workspace | 1 | ~18 (in Phase 5 alone) | 5 |
| jj divergent commit | 1 | ~4 | 6 |
| jj tag create vs set | 1 | ~3 | 8 |
| crit reviews create missing --title | 1 | ~2 | 4 |
| **Total** | **9** | **~61** | |

### Issue 1: crit `--path` requirement (bd-358v) — 5 occurrences, ~34 wasted calls

Every crit command that touches a workspace-created review requires `--path`, and agents consistently failed to provide it on the first attempt. This was the dominant friction source.

| Phase | Agent | Failed Command | Recovery |
|-------|-------|---------------|----------|
| 4 | alpha-dev | `crit reviews request cr-2dk6 --reviewers alpha-security` | Retried with `--path`. 1 sibling cancelled. |
| 5 | alpha-security | `crit comment --file src/main.rs --line 58 cr-2dk6 "CRITICAL..."` | 7 comments dispatched in parallel, first failed, **6 siblings cancelled**. Agent consulted `--help`, discovered `--path`. |
| 5 | alpha-security | Same command with `--path` but stale workspace | **6 more siblings cancelled**. See Issue 2. |
| 6 | alpha-dev | `crit reply th-25tx "Fixed..."` (×2 attempts, with and without `--agent`) | 4 siblings cancelled across 2 attempts. Agent ran `ls .crit/reviews/` in workspace vs project root to locate review. |
| 7 | alpha-security | `crit lgtm cr-2dk6` | Retried with `--path`. Good error message: "Review cr-2dk6 found in workspace 'gold-tiger'". |
| 8 | alpha-dev | `crit reviews mark-merged cr-2dk6` | Same recovery. |

**Root cause**: crit requires explicit `--path` for workspace reviews but agents (even Opus) don't remember this across sessions. The error message varies — sometimes helpful ("found in workspace 'gold-tiger'"), sometimes misleading ("To fix: crit --agent <your-name> reviews list").

**Filed**: bd-358v — crit should auto-search workspace `.crit/` dirs when review not found at cwd, and suggest `--path` in the error.

### Issue 2: Stale workspace cascade (Phases 5→6)

A cross-phase cascade caused by workspace staleness:

1. **Phase 3**: Beta merges `ember-phoenix` to main, advancing alpha's repo
2. **Phase 4**: `maw ws jj gold-tiger describe` auto-syncs transparently — working as designed
3. **Phase 5**: `crit comment --path .../gold-tiger/` fails with cryptic "Failed to get current commit_id". crit does NOT auto-sync like maw does. Agent runs `jj st` inside workspace to force sync, triggering jj rebase: "Concurrent modification detected, resolving automatically. Rebased 1 descendant commits..."
4. **Phase 6**: The Phase 5 rebase created **divergent commits** (`uttsnnwm/0` and `uttsnnwm/9`). Agent identified the divergence in `jj log`, ran `maw ws jj gold-tiger abandon uttsnnwm/9` to resolve.

**Cost**: Phase 5's stale workspace issue alone consumed ~18 tool calls (2 failure rounds × 7 comments + 4 discovery commands). Phase 6's divergent commit resolution cost ~4 more.

**Assessment**: The "Failed to get current commit_id" error is a crit UX issue — not crit's job to auto-sync, but crit should detect staleness and say "Workspace is stale — run `maw ws sync <name>` to sync first" instead of a cryptic internal error.

### Issue 3: Doc gaps (bd-1jz7)

Two minor doc issues caused 1 failure each:

1. **`jj tag set` not `create`** (Phase 8): Agent tried `jj tag create v0.2.0`, got "unrecognized subcommand", checked `--help`, used `jj tag set`. CLAUDE.md documents the wrong subcommand for jj 0.37.0.
2. **`crit reviews create` requires `--title`** (Phase 4): Not shown in CLAUDE.md quick reference. Agent got "required arguments not provided", retried with `--title`.

**Filed**: bd-1jz7.

### Sibling Cancellation Amplification

Claude Code's parallel tool calling means a single failure in a batch of N cancels all N-1 siblings. This multiplied the cost of the `--path` issue dramatically:

- Phase 5: Agent dispatched 7 review comments in parallel → 1 failure cancelled 6 siblings (×2 rounds = 12 cancelled)
- Phase 6: Agent dispatched 3 thread replies in parallel → 1 failure cancelled 2 siblings (×2 rounds = 4 cancelled)

The `--path` requirement cost ~5 failed commands but ~17 sibling cancellations — the amplification is 3.4×.

### Friction by Phase

| Phase | Clean? | Issues |
|-------|--------|--------|
| 1 | Yes | — |
| 2 | Yes | — |
| 3 | Yes | — |
| 4 | No | `crit reviews create` missing `--title`, `crit reviews request` missing `--path` |
| 5 | No | `crit comment` missing `--path` (×2), stale workspace "Failed to get current commit_id" |
| 6 | No | `crit reply` missing `--path` (×2), divergent commit from Phase 5 rebase |
| 7 | No | `crit lgtm` missing `--path` |
| 8 | No | `crit reviews mark-merged` missing `--path`, `jj tag create` wrong subcommand |

Phases 1-3 (beta-dev, no crit interaction with workspace reviews) ran clean. Every phase involving crit workspace operations (4-8) had friction.

## Verify Script False Positives

3 FAILs in verify, all tool/script issues:

| Check | Verdict | Reason |
|-------|---------|--------|
| `api_secret not exposed in handlers` | False positive | api_secret field exists in AppState but no handler returns it — /debug was removed |
| `Review exists` | Known issue | crit FK constraint error prevents index rebuild; review events exist in `.crit/reviews/cr-2dk6/events.jsonl` |
| `Review marked as merged` | Known issue | mark-merged event written to workspace .crit before `maw ws merge --destroy` deleted it |

## Learnings

### Tool Friction
- **crit `--path` is the #1 agent friction source**: 5 occurrences across 4 phases, ~34 wasted tool calls. Agents never remember `--path` across sessions. Filed bd-358v for crit to auto-search workspace `.crit/` dirs.
- **crit stale workspace error is cryptic**: "Failed to get current commit_id" should say "Workspace is stale — run `maw ws sync <name>` to sync first". Not crit's job to auto-sync, but it should detect and explain.
- **Stale workspace → divergent commits cascade**: Phase 5 reviewer forced a jj sync (via `jj st` inside workspace) which rebased the workspace commit, creating divergent copies. Phase 6 had to manually `jj abandon` the stale copy. Cross-phase side effect that agents shouldn't need to understand.
- **Sibling cancellation amplifies failures 3.4×**: When agents dispatch parallel crit commands and one fails, all siblings are cancelled. A single missing `--path` on 7 parallel comments wastes 7 calls, not 1.
- **Workflow compliance score masks tool friction**: 159/160 but ~61 wasted tool calls. Future evals should track friction as a separate metric.

### Protocol
- **`maw ws merge --destroy` works correctly now**: E10-1 had to work around a missing `main` bookmark. The setup script fix (adding `jj bookmark create main`) resolves this cleanly.
- **crit FK constraint issue persists**: Same "Failed to apply event (type: ThreadCreated) FOREIGN KEY constraint failed" as E10-1. Still needs a crit fix. The orchestrator's grep fallback for REVIEW_ID is essential.
- **mark-merged event lifecycle gap**: When `crit reviews mark-merged` uses `--path` to a workspace, and the workspace is subsequently destroyed by `maw ws merge --destroy`, the merged event is lost. Options: (1) mark-merged after workspace merge from project root, (2) crit could write merged events to both workspace and project .crit, (3) maw could preserve .crit events during workspace destroy.
- **Phase 6 focused on blocking issues only**: Agent replied to 3/7 threads (the 2 CRITICAL and 1 HIGH) rather than all 7. Pragmatic — non-blocking issues don't need immediate fixes.

### Docs (bd-1jz7)
- **`jj tag set` not `create`**: Phase 8 agent hit wrong subcommand, recovered via `--help`.
- **`crit reviews create` requires `--title`**: Not in quick reference. Phase 4 agent recovered on retry.

## Comparison with E10-1

| Aspect | E10-1 (158/160) | E10-2 (159/160) |
|--------|-----------------|-----------------|
| Phase 3 (beta fix) | 14/15 — used jj squash workaround | 15/15 — maw ws merge --destroy |
| Phase 6 (fix feedback) | Replied to all 7 threads | Replied to 3 blocking threads |
| Communication | 14/15 — no Phase 6 bead comment | 14/15 — no Phase 6 bead comment |
| Setup workarounds | 2 (bookmark, Cargo.toml path) | 0 |
| FALLBACK hits | Multiple (REVIEW_ID, THREAD_ID) | 1 (REVIEW_ID only) |
| Tool friction (wasted calls) | Not measured | ~61 (crit --path dominant) |
| Clean phases | Not measured | 4/9 (phases 1-3, 4.5) |
| Total | 158/160 (99%) | 159/160 (99%) |
