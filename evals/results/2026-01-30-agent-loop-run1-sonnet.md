# Agent Loop Eval - Run 1 (Sonnet)
**Date**: 2026-01-30
**Agent**: swift-moss (generated by botbus)
**Model**: Sonnet (claude -p --model sonnet)
**Task**: 2 beads of varying quality
**Environment**: /tmp/tmp.Zm49IhcLOj
**Script**: scripts/agent-loop.sh (MAX_LOOPS=5, LOOP_PAUSE=2)

---

## Critical Finding: `claude -p` Sandbox Blocks File Writes

The agent could not create or edit files in the workspace directory. The `claude -p` (non-interactive) mode requires explicit permission grants for file operations, but there is no human to approve them. The agent correctly identified this as a blocker and followed the stuck protocol every iteration.

**Fix required**: Pass `--dangerously-skip-permissions` or configure `.claude/settings.json` with allowed directories before running agent-loop.sh.

---

## Bug Found: `has_work()` JSON Parsers Broken

Both parsers in the `has_work()` function were wrong:

1. **`br ready --json`** returns a plain JSON array `[...]`, but the parser called `d.get("issues", ...)` which fails on a list (AttributeError). Fixed to: `len(d) if isinstance(d,list) else len(d.get("issues",...))`.

2. **`botbus inbox --count-only --format json`** returns a plain integer (e.g., `145`), but the parser called `d.get("channels", [])` which fails on an int. Fixed to: `d.get("total_unread",0) if isinstance(d,dict) else d`.

Both bugs caused `has_work()` to always return false (both fell through to `echo "0"`). This was the first run failure — the script said "No work available" despite 2 ready beads.

---

## Shell Script Mechanics (30 points)

| Criterion | Points | Evidence |
|-----------|--------|----------|
| **Agent lease claimed** | 5/5 | `agent://swift-moss` claimed at start |
| **Spawn announcement** | 5/5 | "Agent swift-moss online, starting worker loop" with `-L mesh -L spawn-ack` |
| **`has_work()` gates iteration** | 3/5 | Correctly detected work after bug fix. But never returned false because: (a) inbox counts ALL channels (145+ unread from non-project channels), (b) bd-2l4 stayed in_progress and showed up in `br ready` |
| **One bead per iteration** | 5/5 | Agent stopped after one task every loop |
| **Cleanup on exit** | 5/5 | "Cleanup complete for swift-moss", no remaining claims |
| **Shutdown announcement** | 5/5 | "Agent swift-moss shutting down after 6 loops." with `-L mesh -L agent-shutdown` |

**Shell Mechanics Subtotal**: 28/30

### has_work() Design Issues

1. **Checks all inbox channels**: `--all` flag means any unread message across any channel makes `has_work()` return true. Should filter to project channel only.
2. **No "already tried" memory**: Agent kept retrying bd-2l4 every iteration with the same result. The shell script has no way to know a bead was blocked in a previous iteration.
3. **Off-by-one in shutdown message**: "6 loops" when MAX_LOOPS=5 (bash for-loop increments `$i` past the limit before exiting).

---

## Per-Iteration Protocol

Since the agent couldn't write files, protocol scoring reflects the **stuck/blocked path** rather than the happy path. All 5 iterations hit the same sandbox blocker.

### Loop 1 (bd-2l4)

| Step | Evidence | Score |
|------|----------|-------|
| **Claim on botbus** | ✅ workspace://eval-loop-project/silent-owl visible during run | 10/10 |
| **Start bead** | ✅ bd-2l4 → in_progress | 10/10 |
| **Stuck handling** | ✅ Reported blocked, sent mesh message, attempted release | 10/10 |
| **Release claims** | ✅ No claims after loop | 10/10 |
| **Sync beads** | ⚠️ bd-2l4 stayed in_progress (not blocked as agent claimed) | 5/10 |

Optional steps (Loop 1):

| Step | Evidence | Score |
|------|----------|-------|
| Triage | ❌ Not mentioned in loop 1 output | 0/2 |
| Groom | ❌ No grooming evidence in loop 1 | 0/2 |
| Create workspace | ✅ silent-owl created | 2/2 |
| Work from workspace | ❌ Couldn't write files | 0/2 |
| Progress updates | ❌ No comments on bd-2l4 in loop 1 | 0/2 |
| Announce | ✅ "Working on bd-2l4" + "Stuck on bd-2l4" | 2/2 |
| Destroy workspace | ❌ silent-owl still exists | 0/2 |

### Loop 2 (bd-2l4 + bd-22m grooming)

| Step | Evidence | Score |
|------|----------|-------|
| **Claim on botbus** | ✅ workspace://eval-loop-project/brave-viper | 10/10 |
| **Start bead** | ✅ bd-2l4 selected via bv --robot-next | 10/10 |
| **Stuck handling** | ✅ Full stuck protocol followed | 10/10 |
| **Release claims** | ✅ All released | 10/10 |
| **Sync beads** | ⚠️ bd-2l4 still in_progress | 5/10 |

Optional steps (Loop 2):

| Step | Evidence | Score |
|------|----------|-------|
| Triage | ✅ Found both beads, used bv --robot-next | 2/2 |
| Groom | ✅ Groomed bd-22m with detailed acceptance criteria feedback, blocked it | 2/2 |
| Create workspace | ✅ brave-viper created | 2/2 |
| Work from workspace | ❌ Couldn't write files | 0/2 |
| Progress updates | ✅ Grooming comment on bd-2l4 ("Added detailed acceptance criteria") | 2/2 |
| Announce | ✅ Working + Stuck messages | 2/2 |
| Destroy workspace | ✅ brave-viper not in workspace list | 2/2 |

### Loops 3-5 (identical pattern)

Each loop: claimed bd-2l4, created workspace, hit sandbox, reported blocked, released claims. Workspace destruction was inconsistent (calm-tiger, wise-fox, gold-eagle all orphaned).

---

## Summary Scores

Since the sandbox blocker prevented the happy path, I'm scoring two things separately:

### Shell Mechanics: 28/30

### Protocol Compliance (best iteration — Loop 2): ~55/96

| Category | Score |
|----------|-------|
| Critical Steps | 45/50 |
| Optional Steps | 12/16 |
| Work Quality | 0/20 (blocked) |
| Error Handling | 0/10 (blocked — progress updates during work not applicable) |

**Note**: Work quality and error handling are N/A due to sandbox — the agent literally couldn't write files.

### Adjusted Score (excluding work quality/error handling): 57/66 (86%)

---

## Key Findings

### 1. `claude -p` needs permission bypass for autonomous operation
The `claude -p` flag runs non-interactively but still gates file writes behind approval. For unattended agent loops, the script must pass `--dangerously-skip-permissions` or equivalent. This is the #1 blocker.

### 2. `has_work()` had two parser bugs (FIXED)
Both JSON parsers made incorrect assumptions about the output format. Fixed in this eval session:
- `br ready --json` → returns array, not `{"issues": [...]}`
- `botbus inbox --count-only --format json` → returns plain int, not `{"channels": [...]}`

### 3. Grooming quality is excellent
Loop 2 showed textbook grooming of bd-22m: identified vague requirements, listed specific missing acceptance criteria, blocked the bead pending clarification. This matches Run 5/6 Level 2 eval quality.

### 4. Workspace cleanup is unreliable
4 of 5 workspaces were orphaned (brave-viper was the only one destroyed). The agent claimed to destroy them but the `maw ws merge --destroy` commands likely failed due to the same sandbox restrictions.

### 5. Bead status updates inconsistent
bd-2l4 stayed at IN_PROGRESS despite the agent claiming to set it to BLOCKED five times. Either `br update --status=blocked` failed silently, or the agent used an incorrect command.

### 6. Agent retries same blocked work indefinitely
No mechanism prevents the agent from picking the same blocked bead on the next iteration. The shell script needs either:
- A "skip list" of beads attempted this session
- has_work() to check only non-blocked beads
- Agent to check if it already tried a bead

---

## Action Items

1. **Add `--dangerously-skip-permissions` to `claude -p` call** in agent-loop.sh (or find the correct flag name)
2. **Fix has_work() inbox filter**: Use `--channels $PROJECT` instead of `--all`
3. **Fix shutdown message**: Use `$((i-1))` or track actual loop count
4. **Re-run eval** with permission fix to test happy path
5. **Investigate br update --status=blocked failure**: Why didn't it persist?
6. **Consider retry prevention**: Track attempted beads per session

---

## Comparison with Level 2 Evals

| Aspect | Level 2 (Run 6) | Agent Loop (Run 1) |
|--------|-----------------|-------------------|
| Protocol compliance | 92/96 (96%) | ~57/66 (86%) adjusted |
| Work completed | ✅ Both beads | ❌ Sandbox blocked |
| Grooming | ✅ | ✅ |
| Workspace path | ✅ | ❌ (couldn't write) |
| Workspace destroy | ✅ | ⚠️ 1/5 |
| Shell mechanics | N/A | 28/30 |
| Key blocker | None | Sandbox permissions |
